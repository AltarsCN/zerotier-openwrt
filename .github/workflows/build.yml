name: Build ZeroTier with Controller

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      target:
        description: '选择构建目标 (留空构建全部)'
        required: false
        type: choice
        options:
          - all
          - x86_64
          - aarch64_cortex-a53
          - qualcommax_ipq60xx
          - qualcommax_ipq807x

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 - 软路由/虚拟机
          - arch: x86_64
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/x86/64/
            sdk_pattern: immortalwrt-sdk-x86-64
            platform: ImmortalWrt
          
          # aarch64 - 通用 ARM64
          - arch: aarch64_cortex-a53
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/rockchip/armv8/
            sdk_pattern: immortalwrt-sdk-rockchip-armv8
            platform: ImmortalWrt
          
          # QCA IPQ60xx - 京东云AX1800/AX6000等
          - arch: qualcommax_ipq60xx
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/qualcommax/ipq60xx/
            sdk_pattern: immortalwrt-sdk-qualcommax-ipq60xx
            platform: ImmortalWrt
          
          # QCA IPQ807x - 红米AX6等高端设备
          - arch: qualcommax_ipq807x
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/qualcommax/ipq807x/
            sdk_pattern: immortalwrt-sdk-qualcommax-ipq807x
            platform: ImmortalWrt

    steps:
      - name: Check if should build this target
        id: check
        run: |
          TARGET="${{ github.event.inputs.target }}"
          if [ -z "$TARGET" ] || [ "$TARGET" = "all" ] || [ "$TARGET" = "${{ matrix.arch }}" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Free disk space
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo apt-get clean
          df -h

      - name: Install dependencies
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync unzip zlib1g-dev file wget zstd

      - name: Download SDK
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "Downloading SDK for ${{ matrix.arch }} from ${{ matrix.sdk_url }}"
          
          # Find SDK filename (try .tar.zst first, then .tar.xz)
          SDK_FILE=$(curl -sL "${{ matrix.sdk_url }}" | grep -oE '${{ matrix.sdk_pattern }}[^"]+\.tar\.zst' | head -1)
          if [ -z "$SDK_FILE" ]; then
            SDK_FILE=$(curl -sL "${{ matrix.sdk_url }}" | grep -oE '${{ matrix.sdk_pattern }}[^"]+\.tar\.xz' | head -1)
          fi
          
          echo "Found SDK: $SDK_FILE"
          
          if [ -z "$SDK_FILE" ]; then
            echo "ERROR: Could not find SDK for ${{ matrix.arch }}"
            exit 1
          fi
          
          # Download
          wget -q --show-progress "${{ matrix.sdk_url }}${SDK_FILE}" -O sdk_archive
          
          # Extract based on extension
          if [[ "$SDK_FILE" == *.zst ]]; then
            zstd -d sdk_archive -o sdk.tar
            tar xf sdk.tar
          else
            tar xf sdk_archive
          fi
          
          mv immortalwrt-sdk-* sdk
          ls -la sdk/

      - name: Patch official zerotier to enable controller
        if: steps.check.outputs.should_build == 'true'
        working-directory: sdk
        run: |
          # Update feeds first
          ./scripts/feeds update packages
          
          # Patch the official zerotier Makefile to add controller option
          ZEROTIER_DIR="feeds/packages/net/zerotier"
          
          # Add ZEROTIER_ENABLE_CONTROLLER to Config.in if not already present
          if ! grep -q "ZEROTIER_ENABLE_CONTROLLER" "$ZEROTIER_DIR/Config.in"; then
            cat >> "$ZEROTIER_DIR/Config.in" << 'CONFIGEOF'

config ZEROTIER_ENABLE_CONTROLLER
	bool "Enable built-in network controller"
	depends on PACKAGE_zerotier
	default y
	help
	  Enable the built-in ZeroTier network controller.
	  This allows creating and managing ZeroTier networks locally.
CONFIGEOF
          fi
          
          # Patch Makefile to use ZT_CONTROLLER when enabled
          if ! grep -q "ZT_CONTROLLER=1" "$ZEROTIER_DIR/Makefile"; then
            sed -i '/^MAKE_FLAGS.*ZT_EMBEDDED/a \\nifeq ($(CONFIG_ZEROTIER_ENABLE_CONTROLLER),y)\nMAKE_FLAGS += ZT_CONTROLLER=1\nendif' "$ZEROTIER_DIR/Makefile"
          fi
          
          # Show the patched files
          echo "=== Patched Config.in ==="
          tail -20 "$ZEROTIER_DIR/Config.in"
          echo "=== Patched Makefile (ZT_CONTROLLER section) ==="
          grep -A3 "ZT_CONTROLLER" "$ZEROTIER_DIR/Makefile" || true

      - name: Configure build
        if: steps.check.outputs.should_build == 'true'
        working-directory: sdk
        run: |
          ./scripts/feeds install zerotier
          
          cat > .config << 'EOF'
          CONFIG_PACKAGE_zerotier=y
          CONFIG_ZEROTIER_ENABLE_CONTROLLER=y
          EOF
          
          make defconfig
          echo "=== ZeroTier config ==="
          grep -i zerotier .config

      - name: Build zerotier package
        if: steps.check.outputs.should_build == 'true'
        working-directory: sdk
        run: |
          echo "Building zerotier with controller for ${{ matrix.arch }}..."
          make package/feeds/packages/zerotier/compile V=s -j$(nproc) 2>&1 | tee build.log || \
          make package/feeds/packages/zerotier/compile V=s -j1 2>&1 | tee -a build.log

      - name: Collect artifacts
        if: steps.check.outputs.should_build == 'true'
        run: |
          mkdir -p artifacts
          find sdk/bin -name "zerotier*.ipk" -exec cp {} artifacts/ \; 2>/dev/null || true
          find sdk/bin -name "zerotier*.apk" -exec cp {} artifacts/ \; 2>/dev/null || true
          
          # Rename with arch suffix for clarity
          for f in artifacts/*; do
            if [ -f "$f" ]; then
              newname=$(echo "$f" | sed "s/\.ipk/_${{ matrix.arch }}.ipk/; s/\.apk/_${{ matrix.arch }}.apk/")
              mv "$f" "$newname" 2>/dev/null || true
            fi
          done
          
          ls -la artifacts/ || echo "No artifacts found"

      - name: Upload artifacts
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: zerotier-controller-${{ matrix.arch }}
          path: artifacts/
          if-no-files-found: warn

      - name: Upload build log on failure
        if: failure() && steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}
          path: sdk/build.log

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages
          pattern: zerotier-controller-*
          merge-multiple: true

      - name: List packages
        run: |
          echo "=== Release packages ==="
          ls -la packages/ || echo "No packages"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*
          generate_release_notes: true
          body: |
            ## ZeroTier with Built-in Controller
            
            Pre-built packages with `ZT_CONTROLLER=1` enabled.
            
            ### Supported Platforms
            - `x86_64` - 软路由/虚拟机
            - `aarch64_cortex-a53` - Rockchip ARM64 设备
            - `qualcommax_ipq60xx` - 京东云 AX1800/AX6000 等 IPQ60xx 设备
            - `qualcommax_ipq807x` - 红米 AX6 等 IPQ807x 设备
            
            ### Installation
            ```bash
            # 下载对应架构的 ipk/apk 文件后
            opkg install zerotier_*.ipk
            # 或
            apk add zerotier_*.apk
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
