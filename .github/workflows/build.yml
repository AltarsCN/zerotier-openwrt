name: Build ZeroTier with Controller

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/x86/64/
            sdk_pattern: immortalwrt-sdk-x86-64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync unzip zlib1g-dev file wget zstd

      - name: Download SDK
        run: |
          # Find SDK filename
          SDK_FILE=$(curl -sL "${{ matrix.sdk_url }}" | grep -oE '${{ matrix.sdk_pattern }}[^"]+\.tar\.(xz|zst)' | head -1)
          echo "Found SDK: $SDK_FILE"
          
          # Download
          wget -q "${{ matrix.sdk_url }}${SDK_FILE}" -O sdk.tar.zst || \
          wget -q "${{ matrix.sdk_url }}${SDK_FILE}" -O sdk.tar.xz
          
          # Extract
          if [ -f sdk.tar.zst ]; then
            zstd -d sdk.tar.zst
            tar xf sdk.tar
          elif [ -f sdk.tar.xz ]; then
            tar xf sdk.tar.xz
          fi
          
          mv immortalwrt-sdk-* sdk
          ls -la sdk/

      - name: Patch official zerotier to enable controller
        working-directory: sdk
        run: |
          # Update feeds first
          ./scripts/feeds update packages
          
          # Patch the official zerotier Makefile to add controller option
          ZEROTIER_DIR="feeds/packages/net/zerotier"
          
          # Add ZEROTIER_ENABLE_CONTROLLER to Config.in if not already present
          if ! grep -q "ZEROTIER_ENABLE_CONTROLLER" "$ZEROTIER_DIR/Config.in"; then
            cat >> "$ZEROTIER_DIR/Config.in" << 'CONFIGEOF'

config ZEROTIER_ENABLE_CONTROLLER
	bool "Enable built-in network controller"
	depends on PACKAGE_zerotier
	default y
	help
	  Enable the built-in ZeroTier network controller.
	  This allows creating and managing ZeroTier networks locally.
CONFIGEOF
          fi
          
          # Patch Makefile to use ZT_CONTROLLER when enabled
          sed -i '/^MAKE_FLAGS.*ZT_EMBEDDED/a \\nifeq ($(CONFIG_ZEROTIER_ENABLE_CONTROLLER),y)\nMAKE_FLAGS += ZT_CONTROLLER=1\nendif' "$ZEROTIER_DIR/Makefile"
          
          # Show the patched files
          echo "=== Patched Config.in ==="
          cat "$ZEROTIER_DIR/Config.in"
          echo "=== Patched Makefile (relevant section) ==="
          grep -A5 "ZT_CONTROLLER\|ZEROTIER_ENABLE_CONTROLLER" "$ZEROTIER_DIR/Makefile" || true

      - name: Configure build
        working-directory: sdk
        run: |
          ./scripts/feeds install zerotier
          
          cat > .config << 'EOF'
          CONFIG_PACKAGE_zerotier=y
          CONFIG_ZEROTIER_ENABLE_CONTROLLER=y
          EOF
          
          make defconfig
          grep -i zerotier .config

      - name: Build zerotier package
        working-directory: sdk
        run: |
          make package/feeds/packages/zerotier/compile V=s -j$(nproc) 2>&1 | tee build.log || \
          make package/feeds/packages/zerotier/compile V=s -j1 2>&1 | tee -a build.log

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          find sdk/bin -name "zerotier*.ipk" -exec cp {} artifacts/ \; 2>/dev/null || true
          find sdk/bin -name "zerotier*.apk" -exec cp {} artifacts/ \; 2>/dev/null || true
          ls -la artifacts/ || echo "No artifacts found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zerotier-controller-${{ matrix.arch }}
          path: artifacts/
          if-no-files-found: warn

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}
          path: sdk/build.log

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages
          pattern: zerotier-controller-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
