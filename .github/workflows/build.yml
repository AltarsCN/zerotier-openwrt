name: Build ZeroTier with Controller

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      target:
        description: '选择构建目标 (留空构建全部)'
        required: false
        type: choice
        options:
          - all
          - x86_64
          - aarch64_cortex-a53
          - qualcommax_ipq60xx
          - qualcommax_ipq807x
      create_release:
        description: '是否创建 Release'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/x86/64/
            sdk_pattern: immortalwrt-sdk-x86-64
            platform: ImmortalWrt
          - arch: aarch64_cortex-a53
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/rockchip/armv8/
            sdk_pattern: immortalwrt-sdk-rockchip-armv8
            platform: ImmortalWrt
          - arch: qualcommax_ipq60xx
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/qualcommax/ipq60xx/
            sdk_pattern: immortalwrt-sdk-qualcommax-ipq60xx
            platform: ImmortalWrt
          - arch: qualcommax_ipq807x
            sdk_url: https://downloads.immortalwrt.org/snapshots/targets/qualcommax/ipq807x/
            sdk_pattern: immortalwrt-sdk-qualcommax-ipq807x
            platform: ImmortalWrt

    steps:
      - name: Check if should build this target
        id: check
        run: |
          TARGET="${{ github.event.inputs.target }}"
          if [ -z "$TARGET" ] || [ "$TARGET" = "all" ] || [ "$TARGET" = "${{ matrix.arch }}" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Free disk space
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo apt-get clean
          df -h

      - name: Install dependencies
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync unzip zlib1g-dev file wget zstd

      - name: Download SDK
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "Downloading SDK for ${{ matrix.arch }} from ${{ matrix.sdk_url }}"
          SDK_FILE=$(curl -sL "${{ matrix.sdk_url }}" | grep -oE '${{ matrix.sdk_pattern }}[^"]+\.tar\.zst' | head -1)
          if [ -z "$SDK_FILE" ]; then
            SDK_FILE=$(curl -sL "${{ matrix.sdk_url }}" | grep -oE '${{ matrix.sdk_pattern }}[^"]+\.tar\.xz' | head -1)
          fi
          echo "Found SDK: $SDK_FILE"
          if [ -z "$SDK_FILE" ]; then
            echo "ERROR: Could not find SDK for ${{ matrix.arch }}"
            exit 1
          fi
          wget -q --show-progress "${{ matrix.sdk_url }}${SDK_FILE}" -O sdk_archive
          if [[ "$SDK_FILE" == *.zst ]]; then
            zstd -d sdk_archive -o sdk.tar
            tar xf sdk.tar
          else
            tar xf sdk_archive
          fi
          mv immortalwrt-sdk-* sdk
          ls -la sdk/

      - name: Configure feeds and package
        if: steps.check.outputs.should_build == 'true'
        working-directory: sdk
        run: |
          # 更新 feeds 获取依赖，但不安装 zerotier（避免覆盖我们的版本）
          ./scripts/feeds update packages
          ./scripts/feeds install libminiupnpc libnatpmp
          
          # 删除 feeds 中的 zerotier 包（如果存在）
          rm -rf feeds/packages/net/zerotier 2>/dev/null || true
          rm -rf package/feeds/packages/zerotier 2>/dev/null || true
          
          # 使用本仓库的 zerotier 包（已含控制器支持）
          cp -r ../net/zerotier package/
          echo "=== 使用本地 zerotier 包 ==="
          head -30 package/zerotier/Makefile

      - name: Configure build
        if: steps.check.outputs.should_build == 'true'
        working-directory: sdk
        run: |
          # 生成配置 - 必须在 defconfig 之后再追加子选项
          echo "CONFIG_PACKAGE_zerotier=y" > .config
          make defconfig
          
          # defconfig 后追加控制器选项
          sed -i 's/# CONFIG_ZEROTIER_ENABLE_CONTROLLER is not set/CONFIG_ZEROTIER_ENABLE_CONTROLLER=y/' .config
          grep -q "CONFIG_ZEROTIER_ENABLE_CONTROLLER=y" .config || echo "CONFIG_ZEROTIER_ENABLE_CONTROLLER=y" >> .config
          
          echo "=== ZeroTier config ==="
          grep -i zerotier .config

      - name: Build zerotier package
        if: steps.check.outputs.should_build == 'true'
        working-directory: sdk
        run: |
          echo "Building zerotier with controller for ${{ matrix.arch }}..."
          make package/zerotier/compile V=s -j$(nproc) 2>&1 | tee build.log
          BUILD_RESULT=$?
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "=== Build failed, retrying with single thread ==="
            make package/zerotier/compile V=s -j1 2>&1 | tee -a build.log
          fi
          echo "=== Searching for built packages ==="
          find bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) 2>/dev/null | head -20

      - name: Collect artifacts
        if: steps.check.outputs.should_build == 'true'
        run: |
          mkdir -p artifacts
          echo "=== Searching all package files ==="
          find sdk/bin -type f \( -name "*.ipk" -o -name "*.apk" \) 2>/dev/null
          
          find sdk/bin -name "zerotier*.ipk" -exec cp {} artifacts/ \; 2>/dev/null || true
          find sdk/bin -name "zerotier*.apk" -exec cp {} artifacts/ \; 2>/dev/null || true
          
          # 重命名添加架构标识
          for f in artifacts/*; do
            if [ -f "$f" ]; then
              base=$(basename "$f")
              if [[ "$base" == *.ipk ]]; then
                newname="${base%.ipk}_${{ matrix.arch }}.ipk"
              elif [[ "$base" == *.apk ]]; then
                newname="${base%.apk}_${{ matrix.arch }}.apk"
              else
                continue
              fi
              mv "$f" "artifacts/$newname" 2>/dev/null || true
            fi
          done
          
          echo "=== Artifacts collected ==="
          ls -la artifacts/ || echo "No artifacts found"

      - name: Upload artifacts
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: zerotier-controller-${{ matrix.arch }}
          path: artifacts/
          if-no-files-found: warn

      - name: Upload build log
        if: always() && steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.arch }}
          path: sdk/build.log
          if-no-files-found: ignore

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages
          pattern: zerotier-controller-*
          merge-multiple: true

      - name: List packages
        run: |
          echo "=== Release packages ==="
          ls -la packages/ || echo "No packages"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('build-{0}', steps.date.outputs.date) }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('Build {0}', steps.date.outputs.date) }}
          files: packages/*
          generate_release_notes: ${{ startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          body: |
            ## ZeroTier with Built-in Controller
            
            Pre-built packages with `ZT_CONTROLLER=1` enabled.
            
            ### Supported Platforms
            - `x86_64` - 软路由/虚拟机
            - `aarch64_cortex-a53` - Rockchip ARM64 设备
            - `qualcommax_ipq60xx` - 京东云 AX1800/AX6000 等 IPQ60xx 设备
            - `qualcommax_ipq807x` - 红米 AX6 等 IPQ807x 设备
            
            ### Installation
            ```bash
            opkg install zerotier_*.ipk
            # 或
            apk add zerotier_*.apk
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
